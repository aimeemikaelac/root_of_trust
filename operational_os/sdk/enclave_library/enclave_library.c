#include "enclave_library.h"
#include "system_config.h"
#include "user_mmap_driver.h"
#include <stdio.h>
#include <stdlib.h>
#include "RemoteAttestationDemo.h"
#include "arm_code.h"



int enclave_init(){
  return enclave_init_with_file(DEFAULT_MICROBLAZE_BINARY);
}

int enclave_init_with_file(char *filename){
  // 1. Program memory
  shared_memory program_buffer = getSharedMemoryArea(ECALL_BUFFER_ADDRESS, ECALL_BUFFER_SIZE);
  FILE *program_file = fopen(filename, "r");
  char current_char;
  int buffer_index = 0;
  //TODO: handle 4 byte vs. 1 byte writes
  while((current_char = fget(program_file)) != EOF){
    program_buffer->ptr[buffer_index] = (unsigned char)current_char;
    buffer_index++;
  }
  fclose(program_file);
  cleanupSharedMemoryPointer(program_buffer);
  // 2. Reset microblaze
  shared_memory reset_controller = getSharedMemoryArea(RESET_CONTROLLER_ADDRESS, 0x1000);
  reset_controller->ptr[0] = 1;
  cleanupSharedMemoryPointer(reset_controller);
  // 3. Launch attestation thread that listens for thrift connections and
  // talks thift back
  initialize_remote_attestion_server();
  // 4. Launch ocall listening thread
  // TODO: requires the watch_ocall_buffer() to be autogenerated
  // initialize_ocall_listener();
}

void initialize_remote_attestion_server(){
  int attestation_create = pthread_create(&remote_attestation_thread, NULL, attestation_server_serve, NULL);
  if(attestation_create){
    fprintf(stderr, "Error launching remote attestation server\n");
    exit(-1);
  }
}

void initialize_ocall_listener(){
  // TODO: watch_ocall_buffer() should be autogenerated similar to the
  // microblaze code
  int listener_create = pthread_create(&ocall_listener_thread, NULL, watch_ocall_buffer, NULL);
  if(listener_create){
    fprintf(stderr, "Error launching ocall listener thread\n");
    exit(-1);
  }
}
